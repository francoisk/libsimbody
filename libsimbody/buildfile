# Headers and source files.
#
./: lib{SimTKcommon}: SimTKcommon/hxx{**} \
                      SimTKcommon/cxx{** -tests/**}

./: lib{SimTKmath}: SimTKmath/hxx{**}                 \
                    SimTKmath/cxx{** -**tests/*}      \
                    SimTKmath/{h c}{** -**tests/*}

./: lib{SimTKsimbody}: Simbody/hxx{** -Visualizer/simbody-visualizer/**} \
                       Simbody/cxx{** -Visualizer/simbody-visualizer/** -tests/**}

# Libraries
#
sys_libs =
if ($cxx.target.class != 'windows')
{
  sys_libs += -llapack -ldl -lm

  if ($cxx.target.class != 'macos')
    sys_libs += -pthread -lrt
}

lib{SimTKcommon}: cxx.libs += $sys_libs

lib{SimTKmath}: lib{SimTKcommon}
lib{SimTKsimbody}: lib{SimTKcommon SimTKmath}

# SimTKcommon/ source subdirectories.
#
common_dirs = BigMatrix         \
              Geometry          \
              Mechanics         \
              Polynomial        \
              Random            \
              Scalar            \
              Simulation        \
              SmallMatrix

# SimTKmath/ source subdirectories.
#
math_dirs = LinearAlgebra       \
            Integrators         \
            Optimizers          \
            Geometry

# Simbody/ source subdirectories.
#
simbody_dirs = Visualizer

# Build options: SimTKcommon
#
common_includes = "-I$src_base/SimTKcommon/include"
for d: $common_dirs
  common_includes += "-I$src_base/SimTKcommon/$d/include"

SimTKcommon/obj{*}:                                                             \
  cxx.poptions += $common_includes                                              \
                  -DSimTK_SimTKCOMMON_AUTHORS=\"Michael.Sherman_Peter.Eastman\" \
                  -DSimTK_SimTKCOMMON_COPYRIGHT_YEARS=\"2005-10\"               \
                  -DSimTK_SimTKCOMMON_LIBRARY_NAME=SimTKcommon                  \
                  -DSimTK_SimTKCOMMON_MAJOR_VERSION="$version.major"            \
                  -DSimTK_SimTKCOMMON_MINOR_VERSION="$version.minor"            \
                  -DSimTK_SimTKCOMMON_PATCH_VERSION="$version.patch"

SimTKcommon/objs{*}: cxx.poptions += -DSimTK_SimTKCOMMON_BUILDING_SHARED_LIBRARY        \
                                     -DSimTKcommon_EXPORTS

SimTKcommon/obja{*}: cxx.poptions += -DSimTK_SimTKCOMMON_BUILDING_STATIC_LIBRARY

# Build options: SimTKmath
#
math_includes = "-I$src_base/SimTKmath/include"
for d: $math_dirs
  math_includes += "-I$src_base/SimTKmath/$d/include"

SimTKmath/obj{*}:                                                               \
  cc.poptions += $math_includes                                                 \
                 "-I$src_base/Integrators/src/CPodes/sundials/include"          \
                 -DSimTK_SIMMATH_AUTHORS=\"Jack.Middleton_Michael.Sherman\"     \
                 -DSimTK_SIMMATH_COPYRIGHT_YEARS=\"2005-10\"                    \
                 -DSimTK_SIMMATH_LIBRARY_NAME=SimTKmath                         \
                 -DSimTK_SIMMATH_MAJOR_VERSION="$version.major"                 \
                 -DSimTK_SIMMATH_MINOR_VERSION="$version.minor"                 \
                 -DSimTK_SIMMATH_PATCH_VERSION="$version.patch"

SimTKmath/objs{*}: cc.poptions += -DSimTK_SIMMATH_BUILDING_SHARED_LIBRARY       \
                                  -DSimTKmath_EXPORTS

SimTKmath/obja{*}: cc.poptions += -DSimTK_SIMMATH_BUILDING_STATIC_LIBRARY

# Build options: SimTKsimbody
#
# Note that the various path/directory macros are only used to launch the
# Visualizer executable which is not supported so just use fake values for the
# sake of simplicity (and to flush out problems early).
#
simbody_includes = "-I$src_base/Simbody/include"
for d: $simbody_dirs
  simbody_includes += "-I$src_base/Simbody/$d/include"

Simbody/obj{*}:                                                                 \
  cxx.poptions += $simbody_includes                                             \
                  -DSimTK_SIMBODY_AUTHORS=\"Michael.Sherman_Peter.Eastman\"     \
                  -DSimTK_SIMBODY_COPYRIGHT_YEARS=\"2005-20\"                   \
                  -DSimTK_SIMBODY_LIBRARY_NAME=SimTKsimbody                     \
                  -DSimTK_SIMBODY_MAJOR_VERSION="$version.major"                \
                  -DSimTK_SIMBODY_MINOR_VERSION="$version.minor"                \
                  -DSimTK_SIMBODY_PATCH_VERSION="$version.patch"                \
                  -DSIMBODY_PATH_FROM_LIBDIR_TO_VIZ_DIR="\"nonexistent_dir\""   \
                  -DSIMBODY_VISUALIZER_INSTALL_DIR="\"nonexistent_dir\""        \
                  -DSIMBODY_VISUALIZER_REL_INSTALL_DIR="\"nonexistent_dir\""

Simbody/objs{*}: cxx.poptions += -DSimTK_SIMBODY_BUILDING_SHARED_LIBRARY        \
                                 -DSimTKsimbody_EXPORTS

Simbody/obja{*}: cxx.poptions += -DSimTK_SIMBODY_BUILDING_STATIC_LIBRARY

# Export options: SimTKcommon
#
lib{SimTKcommon}: cxx.export.poptions = $common_includes

if ($cxx.target.class != 'windows')
  lib{SimTKcommon}: cxx.export.libs += $sys_libs

# Export options: SimTKmath
#
lib{SimTKmath}:
{
  cxx.export.poptions = $math_includes
  cxx.export.libs = lib{SimTKcommon}
}

# Export options: SimTKsimbody
#
lib{SimTKsimbody}:
{
  cxx.export.poptions = $simbody_includes
  cxx.export.libs = lib{SimTKcommon SimTKmath}
}

# Export options: All libraries
#
liba{SimTKcommon SimTKmath SimTKsimbody}: \
  cxx.export.poptions += -DSimTK_USE_STATIC_LIBRARIES

# For pre-releases use the complete version to make sure they cannot
# be used in place of another pre-release or the final version. See
# the version module for details on the version.* variable values.
#
if $version.pre_release
  lib{SimTKcommon SimTKmath SimTKsimbody}: \
    bin.lib.version = "-$version.project_id"
else
  lib{SimTKcommon SimTKmath SimTKsimbody}: \
    bin.lib.version = "-$version.major.$version.minor"

# Installation
#
# The general header installation scheme is as follows.
#
#   The "Core", "Top", and "Internal" names are from the upstream
#   CMakeLists.txt.
#
#   <srcdir> Is the library's source directory.
#
#   <incdir> is the include directory the library's headers will be installed
#            to below include/simbody/.
#
# Core headers
#
# <srcdir>/include/h          -> include/simbody/
# <srcdir>/<subdir>/include/h -> include/simbody/

# Top headers
#
# <srcdir>/include/<incdir>/h          -> include/simbody/<incdir>/
# <srcdir>/<subdir>/include/<incdir>/h -> include/simbody/<incdir>/

# Internal headers
#
# <srcdir>/include/<incdir>/internal/h         -> include/simbody/<incdir>/internal/
# <srcdir>/<subdir>include/<incdir>/internal/h -> include/simbody/<incdir>/internal/
#
{hxx h}{*}: install = false # Default to not installed

# SimTKcommon
#
for d: . $common_dirs
{
  # Core headers
  for h: SimTKcommon/$d/include/hxx{*}
    $h@./SimTKcommon/$d/include/: \
      install = include/simbody/

  # Top headers
  for h: SimTKcommon/$d/include/SimTKcommon/hxx{*}
    $h@./SimTKcommon/$d/include/SimTKcommon/: \
      install = include/simbody/SimTKcommon/

  # Internal headers
  for h: SimTKcommon/$d/include/SimTKcommon/internal/hxx{*}
    $h@./SimTKcommon/$d/include/SimTKcommon/internal/: \
      install = include/simbody/SimTKcommon/internal/
}

# SiMTKmath
#
for d: . $math_dirs
{
  # Core headers
  for h: SimTKmath/$d/include/hxx{*}
    $h@./SimTKmath/$d/include/: \
      install = include/simbody/

  # Top headers
  for h: SimTKmath/$d/include/simmath/hxx{*}
    $h@./SimTKmath/$d/include/simmath/: \
      install = include/simbody/simmath/

  # Internal headers
  for h: SimTKmath/$d/include/simmath/internal/hxx{*}
    $h@./SimTKmath/$d/include/simmath/internal/: \
      install = include/simbody/simmath/internal/
}

# Simbody
#
for d: . $simbody_dirs
{
  # Core headers
  for h: Simbody/$d/include/hxx{*}
    $h@./Simbody/$d/include/: \
      install = include/simbody/

  # Top headers
  for h: Simbody/$d/include/simbody/hxx{*}
    $h@./Simbody/$d/include/simbody/: \
      install = include/simbody/simbody/

  # Internal headers
  for h: Simbody/$d/include/simbody/internal/hxx{*}
    $h@./Simbody/$d/include/simbody/internal/: \
      install = include/simbody/simbody/internal/
}

lib{SimTKcommon SimTKmath SimTKsimbody}: cxx.pkgconfig.include = include/simbody/
